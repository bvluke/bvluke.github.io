<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Swap with PancakeSwap V3 SDK (0.01% Fee)</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 20px auto;
            padding: 20px;
        }
        .input-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        #status {
            margin-top: 20px;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Token Swap with PancakeSwap V3 SDK (0.01% Fee)</h1>
    <div class="input-group">
        <label for="tokenA">Token A Address</label>
        <input type="text" id="tokenA" value="0x55d398326f99059fF775485246999027B3197955" placeholder="Enter Token A Address">
    </div>
    <div class="input-group">
        <label for="amountA">Amount of Token A</label>
        <input type="number" id="amountA" placeholder="Enter Amount">
    </div>
    <div class="input-group">
        <label for="tokenB">Token B Address</label>
        <input type="text" id="tokenB" value="0xFf7d6A96ae471BbCD7713aF9CB1fEeB16cf56B41" placeholder="Enter Token B Address">
    </div>
    <div class="input-group">
        <label for="slippage">Slippage Tolerance (%)</label>
        <input type="number" id="slippage" placeholder="Enter Slippage (e.g., 0.5)" step="0.1">
    </div>
    <button onclick="connectWallet()">Connect Binance Web3 Wallet</button>
    <button onclick="executeSwap()" disabled id="swapButton">Execute Swap</button>
    <div id="status"></div>

    <script src="https://unpkg.com/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/@pancakeswap/v3-sdk@1.0.1/dist/pancakeswap-v3-sdk.js"></script>
    <script src="https://unpkg.com/@binance/w3w-ethereum-provider@0.1.0/dist/index.umd.js"></script>
    <script>
        const { ChainId, Token, CurrencyAmount, TradeType, Percent, Pool, Route, Trade, SwapRouter } = PancakeSwapV3;
        let provider, signer, walletAddress;

        const pancakeV3RouterAddress = '0x13f4EA83D0bd40E75C8222255bc855a974568Dd4'; // PancakeSwap V3 Router

        async function connectWallet() {
            try {
                // Initialize Binance Web3 Wallet provider
                const binanceProvider = new window.BinanceWeb3Provider({
                    chainId: 56, // BNB Smart Chain
                    rpcUrls: ['https://bsc-dataseed.binance.org/']
                });

                // Request accounts
                const accounts = await binanceProvider.request({ method: 'eth_requestAccounts' });
                provider = new ethers.providers.Web3Provider(binanceProvider);
                signer = provider.getSigner();
                walletAddress = accounts[0];
                document.getElementById('status').innerText = `Connected: ${walletAddress}`;
                document.getElementById('swapButton').disabled = false;
            } catch (error) {
                document.getElementById('status').innerText = `Error connecting Binance Web3 Wallet: ${error.message}`;
            }
        }

        async function approveToken(tokenAddress, amount, decimals) {
            const tokenContract = new ethers.Contract(tokenAddress, [
                'function approve(address spender, uint256 amount) external returns (bool)'
            ], signer);
            const parsedAmount = ethers.utils.parseUnits(amount.toString(), decimals);
            const tx = await tokenContract.approve(pancakeV3RouterAddress, parsedAmount);
            await tx.wait();
            document.getElementById('status').innerText += `\nApproved token ${tokenAddress}`;
        }

        async function executeSwap() {
            const tokenAAddress = document.getElementById('tokenA').value;
            const amountA = document.getElementById('amountA').value;
            const tokenBAddress = document.getElementById('tokenB').value;
            const slippage = document.getElementById('slippage').value;

            if (!tokenAAddress || !amountA || !tokenBAddress || !slippage) {
                document.getElementById('status').innerText = 'Please fill all fields.';
                return;
            }

            try {
                // Initialize tokens
                const tokenA = new Token(ChainId.BSC, tokenAAddress, 18);
                const tokenB = new Token(ChainId.BSC, tokenBAddress, 18);
                const amountIn = CurrencyAmount.fromRawAmount(tokenA, ethers.utils.parseUnits(amountA, 18).toString());

                // Fetch V3 pool with fee tier 100 (0.01%)
                const pool = await Pool.init({
                    token0: tokenA.sortsBefore(tokenB) ? tokenA : tokenB,
                    token1: tokenA.sortsBefore(tokenB) ? tokenB : tokenA,
                    fee: 100, // Fee tier: 100 (0.01%)
                    provider
                });

                // Determine swap direction
                const zeroForOne = tokenA.sortsBefore(tokenB);
                const route = new Route([pool], tokenA, tokenB);
                const trade = await Trade.exactIn({
                    route,
                    amountIn,
                    tradeType: TradeType.EXACT_INPUT
                });

                // Calculate slippage
                const slippageTolerance = new Percent(Math.floor(slippage * 100).toString(), '10000'); // e.g., 0.5% -> 50/10000
                const amountOutMin = trade.minimumAmountOut(slippageTolerance).quotient.toString();

                // Approve Token A
                await approveToken(tokenAAddress, amountA, 18);

                // Swap A to B
                const swapParams = {
                    recipient: walletAddress,
                    deadline: Math.floor(Date.now() / 1000) + 60 * 20,
                    slippageTolerance,
                    inputAmount: amountIn
                };
                const { calldata, value } = SwapRouter.swapCallParameters(trade, swapParams);
                const txAB = await signer.sendTransaction({
                    to: pancakeV3RouterAddress,
                    data: calldata,
                    value: ethers.BigNumber.from(value),
                    gasLimit: 300000
                });
                const receiptAB = await txAB.wait();
                document.getElementById('status').innerText += `\nSwapped ${amountA} Token A to Token B`;

                // Get amount of Token B received
                const amountBReceived = receiptAB.events.find(e => e.event === 'Swap')?.args[3] || trade.outputAmount.quotient.toString();
                const amountB = CurrencyAmount.fromRawAmount(tokenB, amountBReceived.toString());

                // Create pool and trade for swap B to A
                const poolBA = await Pool.init({
                    token0: tokenB.sortsBefore(tokenA) ? tokenB : tokenA,
                    token1: tokenB.sortsBefore(tokenA) ? tokenA : tokenB,
                    fee: 100, // Fee tier: 100 (0.01%)
                    provider
                });
                const routeBA = new Route([poolBA], tokenB, tokenA);
                const tradeBA = await Trade.exactIn({
                    route: routeBA,
                    amountIn: amountB,
                    tradeType: TradeType.EXACT_INPUT
                });

                // Calculate slippage for swap B to A
                const amountOutMinBA = tradeBA.minimumAmountOut(slippageTolerance).quotient.toString();

                // Approve Token B
                await approveToken(tokenBAddress, ethers.utils.formatUnits(amountBReceived, 18), 18);

                // Swap B to A
                const swapParamsBA = {
                    recipient: walletAddress,
                    deadline: Math.floor(Date.now() / 1000) + 60 * 20,
                    slippageTolerance,
                    inputAmount: amountB
                };
                const { calldata: calldataBA, value: valueBA } = SwapRouter.swapCallParameters(tradeBA, swapParamsBA);
                const txBA = await signer.sendTransaction({
                    to: pancakeV3RouterAddress,
                    data: calldataBA,
                    value: ethers.BigNumber.from(valueBA),
                    gasLimit: 300000
                });
                await txBA.wait();
                document.getElementById('status').innerText += `\nSwapped Token B back to Token A`;
            } catch (error) {
                document.getElementById('status').innerText = `Error: ${error.message}`;
            }
        }
    </script>
</body>
</html>
